<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ERRORDON - Enter The Matrix</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; }
        #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Login Screen */
        #loginScreen {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; text-align: center; background: rgba(0,0,0,0.95);
            padding: 60px; border: 2px solid #0f0; border-radius: 10px; box-shadow: 0 0 40px #0f0;
        }
        .matrix-title { color: #0f0; font-size: 48px; margin-bottom: 40px; text-shadow: 0 0 20px #0f0; letter-spacing: 8px; }
        .login-form input {
            width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(0,255,0,0.1);
            border: 2px solid #0f0; color: #0f0; font-family: 'Courier New', monospace;
            font-size: 18px; text-align: center;
        }
        .login-form input::placeholder { color: rgba(0,255,0,0.5); }
        .login-form button {
            width: 100%; padding: 15px; background: #0f0; color: #000; border: none;
            font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; cursor: pointer;
        }
        .login-form button:hover { background: #0c0; box-shadow: 0 0 20px #0f0; }
        
        /* Terminal */
        #terminal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; width: 85%; max-width: 1000px; height: 80vh;
            background: rgba(0,0,0,0.9); border: 2px solid #0f0; border-radius: 8px;
            box-shadow: 0 0 30px #0f0; flex-direction: column;
        }
        .terminal-header {
            background: #0f0; color: #000; padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center; border-radius: 6px 6px 0 0;
        }
        .terminal-title { font-weight: bold; font-size: 16px; letter-spacing: 2px; }
        .terminal-buttons span { margin-left: 15px; cursor: pointer; font-size: 20px; font-weight: bold; }
        .terminal-buttons span:hover { color: #300; }
        #output { flex: 1; overflow-y: auto; padding: 20px; color: #0f0; font-size: 14px; line-height: 1.8; }
        .terminal-input-line { display: flex; align-items: center; padding: 15px 20px; border-top: 1px solid #0f0; }
        #prompt { color: #0f0; margin-right: 10px; font-weight: bold; }
        #commandInput {
            flex: 1; background: transparent; border: none; color: #0f0;
            font-family: 'Courier New', monospace; font-size: 14px; outline: none;
        }
        .command-line { color: #0c0; font-weight: bold; }
        .output-line { color: #0f0; margin: 5px 0; }
        .error-line { color: #f00; }
        
        /* Tetris Overlay */
        #tetrisOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background: rgba(0,0,0,0.98);
        }
        #tetrisOverlay iframe { width: 100%; height: 100%; border: none; }
        #tetrisClose {
            position: fixed; top: 20px; right: 30px; z-index: 1001;
            background: #0f0; color: #000; border: none; padding: 10px 20px;
            font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; cursor: pointer;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #0f0; border-radius: 5px; }
    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>
    
    <!-- Login Screen -->
    <div id="loginScreen">
        <h1 class="matrix-title">ERRORDON</h1>
        <p style="color: #0f0; margin-bottom: 10px; font-size: 16px; letter-spacing: 2px;">A Safe Fediverse Instance</p>
        <p style="color: #0a0; margin-bottom: 25px; font-size: 12px;">ğŸ›¡ï¸ No Porn â€¢ No Hate â€¢ No Fascism</p>
        <div class="login-form">
            <input type="text" id="usernameInput" placeholder="Enter your name..." maxlength="20" autocomplete="off" autofocus>
            <button id="connectBtn">CONNECT</button>
        </div>
        <p style="color: #080; margin-top: 20px; font-size: 11px;">Type "enter matrix" after connecting to access the network</p>
    </div>

    <!-- Terminal -->
    <div id="terminal">
        <div class="terminal-header">
            <span class="terminal-title">ERRORDON TERMINAL v1.0</span>
            <div class="terminal-buttons">
                <span id="logoutBtn" title="Disconnect">Ã—</span>
            </div>
        </div>
        <div id="output"></div>
        <div class="terminal-input-line">
            <span id="prompt">guest@errordon:~$</span>
            <input type="text" id="commandInput" autocomplete="off">
        </div>
    </div>

    <!-- Tetris Overlay -->
    <div id="tetrisOverlay">
        <button id="tetrisClose">â† RETURN TO TERMINAL</button>
        <iframe id="tetrisFrame" src=""></iframe>
    </div>

<script>
// ============================================================================
// MATRIX RAIN
// ============================================================================
const matrixCanvas = document.getElementById('matrixCanvas');
const matrixCtx = matrixCanvas.getContext('2d');
matrixCanvas.width = window.innerWidth;
matrixCanvas.height = window.innerHeight;

const MATRIX_CHARS = 'ã‚¢ã‚¡ã‚«ã‚µã‚¿ãƒŠãƒãƒãƒ¤ãƒ£ãƒ©ãƒ¯ã‚¬ã‚¶ãƒ€ãƒãƒ‘ã‚¤ã‚£ã‚­ã‚·ãƒãƒ‹ãƒ’ãƒŸãƒª0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
const fontSize = 16;
let columns = Math.floor(matrixCanvas.width / fontSize);
let drops = Array.from({ length: columns }, () => Math.random() * matrixCanvas.height / fontSize);

function drawMatrixRain() {
    matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
    matrixCtx.fillStyle = '#0F0';
    matrixCtx.font = fontSize + 'px monospace';
    for (let i = 0; i < columns; i++) {
        const text = MATRIX_CHARS.charAt(Math.floor(Math.random() * MATRIX_CHARS.length));
        matrixCtx.fillText(text, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i] += 0.3 + Math.random() * 0.4;
    }
}
setInterval(drawMatrixRain, 50);

window.addEventListener('resize', () => {
    matrixCanvas.width = window.innerWidth;
    matrixCanvas.height = window.innerHeight;
    columns = Math.floor(matrixCanvas.width / fontSize);
    drops = Array.from({ length: columns }, () => Math.random() * matrixCanvas.height / fontSize);
});

// ============================================================================
// TERMINAL SYSTEM
// ============================================================================
const output = document.getElementById('output');
const commandInput = document.getElementById('commandInput');
const terminal = document.getElementById('terminal');
const loginScreen = document.getElementById('loginScreen');
const usernameInput = document.getElementById('usernameInput');
const promptEl = document.getElementById('prompt');
const tetrisOverlay = document.getElementById('tetrisOverlay');
const tetrisFrame = document.getElementById('tetrisFrame');
const tetrisClose = document.getElementById('tetrisClose');

let username = 'guest';

// Login
function login() {
    const name = usernameInput.value.trim();
    if (name) {
        username = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        localStorage.setItem('matrixUsername', username);
    }
    loginScreen.style.display = 'none';
    terminal.style.display = 'flex';
    promptEl.textContent = username + '@errordon:~$';
    commandInput.focus();
    
    printLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    printLine('â•‘         WELCOME TO ERRORDON - A SAFE FEDIVERSE             â•‘');
    printLine('â•‘  ğŸ›¡ï¸  NO PORN â€¢ NO HATE â€¢ NO FASCISM                         â•‘');
    printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
    printLine('â•‘  Type "enter matrix" to access the social network          â•‘');
    printLine('â•‘  Type "help" for all available commands                    â•‘');
    printLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    printLine('');
    printLine('Connected as: ' + username);
}

function logout() {
    terminal.style.display = 'none';
    loginScreen.style.display = 'block';
    output.innerHTML = '';
    usernameInput.value = '';
    usernameInput.focus();
}

function printLine(text, className) {
    const line = document.createElement('div');
    line.className = className || 'output-line';
    line.textContent = text;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
}

// Event Listeners
document.getElementById('connectBtn').addEventListener('click', login);
usernameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });
document.getElementById('logoutBtn').addEventListener('click', logout);

// Tetris close
tetrisClose.addEventListener('click', closeTetris);
window.addEventListener('message', (e) => { if (e.data === 'closeTetris') closeTetris(); });

function closeTetris() {
    tetrisOverlay.style.display = 'none';
    tetrisFrame.src = '';
    commandInput.focus();
}

// Command Input
commandInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const cmd = commandInput.value.trim();
        if (cmd) {
            printLine(username + '@errordon:~$ ' + cmd, 'command-line');
            handleCommand(cmd);
        }
        commandInput.value = '';
    }
});

// Auto-focus
window.addEventListener('load', () => {
    const stored = localStorage.getItem('matrixUsername');
    if (stored) usernameInput.value = stored;
});

// ============================================================================
// COMMANDS
// ============================================================================
const quotes = [
    "There is no spoon.",
    "You take the red pill â€” you stay in Wonderland.",
    "I know kung fu.",
    "Welcome to the real world.",
    "Unfortunately, no one can be told what the Matrix is.",
    "Welcome to the desert of the real.",
    "I can only show you the door. You're the one that has to walk through it.",
    "Neo, sooner or later you're going to realize there's a difference between knowing the path and walking the path.",
    "Free your mind.",
    "The Matrix has you Neo."
];

function handleCommand(input) {
    const lower = input.toLowerCase();
    const parts = input.split(' ');
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);

    // ENTER MATRIX
    if (lower === 'enter matrix' || lower === 'entermatrix' || lower === 'login') {
        printLine('[INITIATING NEURAL INTERFACE...]');
        // Set session flag so user won't be redirected back
        fetch('/matrix/pass', { method: 'POST', credentials: 'same-origin' }).catch(() => {});
        setTimeout(() => {
            printLine('[CONNECTING TO ERRORDON NETWORK...]');
            setTimeout(() => {
                printLine('[ACCESS GRANTED - ENTERING THE MATRIX...]');
                setTimeout(() => { window.location.href = '/'; }, 800);
            }, 600);
        }, 600);
        return;
    }

    // HELP
    if (cmd === 'help') {
        printLine('');
        printLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        printLine('â•‘              ERRORDON TERMINAL COMMANDS               â•‘');
        printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
        printLine('â•‘  enter matrix  - ğŸ”“ Access Errordon Social Network    â•‘');
        printLine('â•‘  about         - â„¹ï¸  About Errordon                    â•‘');
        printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
        printLine('â•‘  tetris        - ğŸ® Play Tetris game                  â•‘');
        printLine('â•‘  talk <name>   - ğŸ’¬ Talk to Matrix characters         â•‘');
        printLine('â•‘  quote         - ğŸ“œ Random Matrix quote               â•‘');
        printLine('â•‘  hack          - ğŸ’» Hack simulation                   â•‘');
        printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
        printLine('â•‘  clear         - ğŸ§¹ Clear screen                      â•‘');
        printLine('â•‘  date          - ğŸ“… Show date/time                    â•‘');
        printLine('â•‘  whoami        - ğŸ‘¤ Show current user                 â•‘');
        printLine('â•‘  echo <text>   - ğŸ“¢ Echo text                         â•‘');
        printLine('â•‘  logout        - ğŸšª Disconnect                        â•‘');
        printLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        return;
    }

    // ABOUT
    if (cmd === 'about') {
        printLine('');
        printLine('ERRORDON - A Safe Fediverse Instance');
        printLine('=====================================');
        printLine('ğŸ›¡ï¸  AI-Powered Content Moderation (NSFW-Protect)');
        printLine('ğŸš«  Zero Tolerance: No Porn, No Hate, No Fascism');
        printLine('ğŸŒ  Fediverse Compatible (ActivityPub)');
        printLine('ğŸ¨  Matrix Theme');
        printLine('');
        printLine('Type "enter matrix" to join the network.');
        return;
    }

    // TETRIS
    if (cmd === 'tetris') {
        printLine('Loading Tetris...');
        tetrisFrame.src = '/matrix/tetris.html?user=' + encodeURIComponent(username);
        tetrisOverlay.style.display = 'block';
        printLine('Tetris opened! Click RETURN TO TERMINAL or press ESC to exit.');
        return;
    }

    // QUOTE
    if (cmd === 'quote') {
        printLine(quotes[Math.floor(Math.random() * quotes.length)]);
        return;
    }

    // HACK
    if (cmd === 'hack') {
        const msgs = [
            "[ACCESSING MAINFRAME...]", "[ENCRYPTION BYPASS INITIATED...]",
            "[CRYPTO-BARRIER BREACHED]", "[LOGGING IN AS ROOT...]",
            "[KEYSTREAM ALIGNMENT: OK]", "[DATA LINK ESTABLISHED]",
            "[TRINITY: 'I'm inside.']", "[MISSION COMPLETE]"
        ];
        let i = 0;
        const interval = setInterval(() => {
            if (i < msgs.length) { printLine(msgs[i++]); }
            else { clearInterval(interval); printLine('[ACCESS GRANTED]'); }
        }, 400);
        return;
    }

    // TALK - Interactive conversations with Matrix characters
    if (cmd === 'talk') {
        const character = args[0]?.toLowerCase();
        const characters = ['morpheus', 'neo', 'trinity', 'oracle', 'orakel', 'smith'];
        if (!character || !characters.includes(character)) {
            printLine('Usage: talk <character>');
            printLine('Available: ' + characters.join(', '));
            return;
        }
        printLine('[CONNECTING TO ' + character.toUpperCase() + '...]');
        fetch('/matrix/talk_db_' + character + '.json')
            .then(r => r.json())
            .then(db => {
                window.talkDb = db;
                window.talkNode = Object.keys(db)[0];
                showTalkNode();
            })
            .catch(() => printLine('Error: Could not load conversation.'));
        return;
    }

    // CLEAR
    if (cmd === 'clear') { output.innerHTML = ''; return; }

    // DATE
    if (cmd === 'date') { printLine(new Date().toString()); return; }

    // WHOAMI
    if (cmd === 'whoami') { printLine(username); return; }

    // ECHO
    if (cmd === 'echo') { printLine(args.join(' ')); return; }

    // LOGOUT
    if (cmd === 'logout' || cmd === 'exit') { logout(); return; }

    // Talk response (1, 2, 3)
    if (window.talkDb && ['1', '2', '3'].includes(cmd)) {
        if (handleTalkResponse(cmd)) return;
    }

    // UNKNOWN
    printLine('Unknown command: ' + cmd, 'error-line');
    printLine('Type "help" for available commands');
}

// ESC to close Tetris
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && tetrisOverlay.style.display === 'block') closeTetris();
});

// Talk system - show current dialog node
function showTalkNode() {
    if (!window.talkDb || !window.talkNode) return;
    const node = window.talkDb[window.talkNode];
    if (!node) { printLine('[END OF CONVERSATION]'); window.talkDb = null; return; }
    printLine('');
    printLine(node.speaker + ': "' + node.text + '"');
    if (node.options) {
        Object.entries(node.options).forEach(([key, opt]) => {
            printLine('  [' + key + '] ' + opt.text);
        });
        printLine('Type a number to respond:');
    }
}

// Handle talk responses
function handleTalkResponse(num) {
    if (!window.talkDb || !window.talkNode) return false;
    const node = window.talkDb[window.talkNode];
    if (!node || !node.options || !node.options[num]) return false;
    const next = node.options[num].next;
    if (!next) { printLine('[DISCONNECTED]'); window.talkDb = null; return true; }
    window.talkNode = next;
    showTalkNode();
    return true;
}
</script>
</body>
</html>
