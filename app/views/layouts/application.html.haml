!!! 5
%html{ html_attributes }
  %head
    %meta{ charset: 'utf-8' }/
    %meta{ name: 'viewport', content: 'width=device-width, initial-scale=1, viewport-fit=cover' }/

    - if cdn_host?
      %link{ rel: 'dns-prefetch', href: cdn_host }/
      %meta{ name: 'cdn-host', content: cdn_host }/

    - if storage_host?
      %link{ rel: 'dns-prefetch', href: storage_host }/

    - SiteUpload::FAVICON_SIZES.each do |size|
      %link{ rel: 'icon', sizes: "#{size}x#{size}", href: favicon_path(size.to_i) || frontend_asset_path("icons/favicon-#{size}x#{size}.png"), type: 'image/png' }/

    - SiteUpload::APPLE_ICON_SIZES.each do |size|
      %link{ rel: 'apple-touch-icon', sizes: "#{size}x#{size}", href: app_icon_path(size.to_i) || frontend_asset_path("icons/apple-touch-icon-#{size}x#{size}.png") }/

    - if use_mask_icon?
      %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/
    %link{ rel: 'manifest', href: manifest_path(format: :json) }/
    = javascript_inline_tag 'theme-selection.js'
    = theme_color_tags color_scheme
    %meta{ name: 'mobile-web-app-capable', content: 'yes' }/

    %title= html_title

    = theme_style_tags current_theme
    = vite_client_tag
    = vite_react_refresh_tag
    = vite_polyfills_tag
    -# Needed for the wicg-inert polyfill. It needs to be on it's own <style> tag, with this `id`
    = vite_stylesheet_tag 'styles/entrypoints/inert.scss', media: 'all', id: 'inert-style', crossorigin: 'anonymous'
    = vite_typescript_tag 'common.ts', crossorigin: 'anonymous'

    = vite_preload_file_tag "mastodon/locales/#{I18n.locale}.json"
    = csrf_meta_tags unless skip_csrf_meta_tags?
    %meta{ name: 'style-nonce', content: request.content_security_policy_nonce, property: 'csp-nonce', nonce: request.content_security_policy_nonce }

    = custom_stylesheet

    = yield :header_tags

    -# Errordon: Matrix color configuration (for JavaScript)
    - matrix_color = defined?(Errordon::MATRIX_COLOR) ? Errordon::MATRIX_COLOR : 'green'
    %meta{ name: 'errordon-matrix-color', content: matrix_color }/

  -# Errordon: Add theme-matrix class and color class if enabled
  - matrix_enabled = ENV['ERRORDON_MATRIX_THEME_ENABLED'] == 'true' || (defined?(Errordon::THEME) && Errordon::THEME == 'matrix')
  - matrix_color = defined?(Errordon::MATRIX_COLOR) ? Errordon::MATRIX_COLOR : 'green'
  - body_class_list = body_classes
  - body_class_list = "#{body_class_list} theme-matrix matrix-color-#{matrix_color}" if matrix_enabled
  %body{ class: body_class_list, 'data-matrix-color': matrix_color }
    -# Errordon Matrix Theme - Rain Background Canvas (always present, JS controls visibility)
    %canvas#matrixRainCanvas{ style: 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;' }
    
    -# Errordon Matrix Theme - Initialization (Web Worker based for smooth scrolling)
    = javascript_tag nonce: request.content_security_policy_nonce do
      :plain
        // Errordon Matrix Rain - Web Worker version (doesn't freeze on scroll)
        (function() {
          document.body.classList.add('theme-matrix');
          
          var canvas = document.getElementById('matrixRainCanvas');
          if (!canvas) return;
          
          // Check reduced motion preference
          if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            canvas.style.display = 'none';
            return;
          }
          
          var ctx = canvas.getContext('2d', { alpha: false });
          canvas.style.willChange = 'transform';
          
          function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
          initCanvas();
          
          var matrixColor = document.body.dataset.matrixColor || 'green';
          var colors = { green: '#00ff00', red: '#ff0000', blue: '#00bfff', purple: '#bf00ff' };
          var rainColor = colors[matrixColor] || '#00ff00';
          
          var chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789';
          var fontSize = 14;
          var columns, drops;
          
          function initDrops() {
            columns = Math.floor(canvas.width / fontSize);
            drops = [];
            for (var i = 0; i < columns; i++) {
              drops[i] = Math.random() * -100;
            }
          }
          initDrops();
          
          var lastTime = 0;
          var targetInterval = 50; // 20 FPS
          
          function draw(timestamp) {
            // Time-based animation - catches up if frames were skipped
            var elapsed = timestamp - lastTime;
            var steps = Math.min(Math.floor(elapsed / targetInterval), 3); // Max 3 catch-up steps
            
            if (steps > 0) {
              lastTime = timestamp - (elapsed % targetInterval);
              
              for (var s = 0; s < steps; s++) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = fontSize + 'px monospace';
                
                for (var i = 0; i < columns; i++) {
                  var text = chars[Math.floor(Math.random() * chars.length)];
                  ctx.fillStyle = Math.random() > 0.98 ? '#fff' : rainColor;
                  ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                  
                  if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                  }
                  drops[i] += 0.5;
                }
              }
            }
            
            requestAnimationFrame(draw);
          }
          
          // Start animation
          requestAnimationFrame(function(ts) {
            lastTime = ts;
            requestAnimationFrame(draw);
          });
          
          // Resize with debounce
          var resizeTimeout;
          window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
              initCanvas();
              initDrops();
            }, 100);
          });
        })();
    = content_for?(:content) ? yield(:content) : yield

    .logo-resources{ 'tabindex' => '-1', 'inert' => true, 'aria-hidden' => 'true' }
      = inline_svg_tag 'logo-symbol-icon.svg'
      = inline_svg_tag 'logo-symbol-wordmark.svg'
    
    -# Errordon Matrix Theme JavaScript is loaded via common.ts entrypoint
