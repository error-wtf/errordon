- content_for :header_tags do
  %meta{ name: 'robots', content: 'noindex' }/
  %title ERRORDON - Enter The Matrix
  %meta{ name: 'description', content: 'Errordon - A Safe Fediverse Instance. No Porn, No Hate, No Fascism.' }/

%style
  :plain
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; width: 100vw; }
    #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .login-screen { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; text-align: center; background: rgba(0, 0, 0, 0.95); padding: 60px; border: 2px solid #0f0; border-radius: 10px; box-shadow: 0 0 40px #0f0; }
    .matrix-title { color: #0f0; font-size: 48px; margin-bottom: 20px; text-shadow: 0 0 20px #0f0; letter-spacing: 8px; }
    .login-form input { width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(0, 255, 0, 0.1); border: 2px solid #0f0; color: #0f0; font-family: 'Courier New', monospace; font-size: 18px; text-align: center; }
    .login-form input::placeholder { color: rgba(0, 255, 0, 0.5); }
    .login-form button { width: 100%; padding: 15px; background: #0f0; color: #000; border: none; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .login-form button:hover { background: #0c0; box-shadow: 0 0 20px #0f0; }
    .terminal { position: relative; z-index: 10; width: 80%; max-width: 1000px; height: 75vh; margin: 10vh auto; background: rgba(0, 0, 0, 0.7); border: 2px solid #0f0; border-radius: 8px; box-shadow: 0 0 30px #0f0; display: flex; flex-direction: column; }
    .terminal-header { background: #0f0; color: #000; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px 6px 0 0; }
    .terminal-title { font-weight: bold; font-size: 16px; letter-spacing: 2px; }
    .terminal-buttons span { margin-left: 15px; cursor: pointer; font-size: 20px; font-weight: bold; }
    .terminal-output { flex: 1; overflow-y: auto; padding: 20px; color: #0f0; font-size: 14px; line-height: 1.8; }
    .terminal-input-line { display: flex; align-items: center; padding: 15px 20px; border-top: 1px solid #0f0; }
    .prompt { color: #0f0; margin-right: 10px; font-weight: bold; }
    .terminal-input { flex: 1; background: transparent; border: none; color: #0f0; font-family: 'Courier New', monospace; font-size: 14px; outline: none; }
    .command-line { color: #0c0; font-weight: bold; }
    .output-line { color: #0f0; margin: 5px 0; }
    .error-line { color: #f00; }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #0f0; border-radius: 5px; }

%canvas#matrixCanvas

#loginScreen.login-screen
  %h1.matrix-title ERRORDON
  %p{style: 'color: #0f0; margin-bottom: 10px; font-size: 16px; letter-spacing: 2px;'} A Safe Fediverse Instance
  %p{style: 'color: #0a0; margin-bottom: 25px; font-size: 12px;'} ğŸ›¡ï¸ No Porn â€¢ No Hate â€¢ No Fascism
  .login-form
    %input#usernameInput{type: 'text', placeholder: 'Enter your name...', maxlength: '20', autocomplete: 'off', autofocus: true}
    %button{onclick: 'login()'} CONNECT
  %p{style: 'color: #080; margin-top: 20px; font-size: 11px;'} Type "enter matrix" after connecting to access the network

#terminal.terminal{style: 'display: none;'}
  .terminal-header
    %span.terminal-title ERRORDON TERMINAL v1.0
    .terminal-buttons
      %span.btn-close{onclick: 'logout()'} Ã—
      %span.btn-minimize âˆ’
      %span.btn-maximize â–¡
  #output.terminal-output
  .terminal-input-line
    %span#prompt.prompt guest@errordon:~$
    %input#commandInput.terminal-input{type: 'text', autocomplete: 'off'}

#tetrisOverlay{style: 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: rgba(0,0,0,0.95);'}
  %iframe#tetrisFrame{src: '', style: 'width: 100%; height: 100%; border: none;'}

:javascript
  // Matrix Rain
  const matrixCanvas = document.getElementById('matrixCanvas');
  const matrixCtx = matrixCanvas.getContext('2d');
  matrixCanvas.width = window.innerWidth;
  matrixCanvas.height = window.innerHeight;

  const MATRIX_CHARS = 'ã‚¢ã‚¡ã‚«ã‚µã‚¿ãƒŠãƒãƒãƒ¤ãƒ£ãƒ©ãƒ¯ã‚¬ã‚¶ãƒ€ãƒãƒ‘ã‚¤ã‚£ã‚­ã‚·ãƒãƒ‹ãƒ’ãƒŸãƒªã‚®ã‚¸ãƒ‚ãƒ“ãƒ”ã‚¦ã‚¥ã‚¯ã‚¹ãƒ„ãƒŒãƒ•ãƒ ãƒ¦ãƒ¥ãƒ«ã‚°ã‚ºãƒ…ãƒ–ãƒ—ã‚¨ã‚§ã‚±ã‚»ãƒ†ãƒãƒ˜ãƒ¡ãƒ¬ã‚²ã‚¼ãƒ‡ãƒ™ãƒšã‚ªã‚©ã‚³ã‚½ãƒˆãƒãƒ›ãƒ¢ãƒ¨ãƒ§ãƒ­ã‚´ã‚¾ãƒ‰ãƒœãƒãƒ´ãƒƒãƒ³0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const fontSize = 16;
  let columns = Math.floor(matrixCanvas.width / fontSize);
  let drops = Array.from({ length: columns }, () => Math.random() * matrixCanvas.height / fontSize);
  let rainActive = true;

  function drawMatrixRain() {
    if (!rainActive) return;
    matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
    matrixCtx.fillStyle = '#0F0';
    matrixCtx.font = fontSize + 'px monospace';
    for (let i = 0; i < columns; i++) {
      const text = MATRIX_CHARS.charAt(Math.floor(Math.random() * MATRIX_CHARS.length));
      matrixCtx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i] += 0.3 + Math.random() * 0.4;
    }
  }
  setInterval(drawMatrixRain, 50);

  window.addEventListener('resize', () => {
    matrixCanvas.width = window.innerWidth;
    matrixCanvas.height = window.innerHeight;
    columns = Math.floor(matrixCanvas.width / fontSize);
    drops = Array.from({ length: columns }, () => Math.random() * matrixCanvas.height / fontSize);
  });

  // Terminal
  const output = document.getElementById('output');
  const commandInput = document.getElementById('commandInput');
  const terminal = document.getElementById('terminal');
  const loginScreen = document.getElementById('loginScreen');
  const usernameInput = document.getElementById('usernameInput');
  const promptEl = document.getElementById('prompt');
  let username = 'guest';

  function login() {
    const name = usernameInput.value.trim();
    if (name) username = name.toLowerCase().replace(/[^a-z0-9]/g, '');
    loginScreen.style.display = 'none';
    terminal.style.display = 'flex';
    promptEl.textContent = username + '@errordon:~$';
    commandInput.focus();
    printLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    printLine('â•‘         WELCOME TO ERRORDON - A SAFE FEDIVERSE             â•‘');
    printLine('â•‘                                                            â•‘');
    printLine('â•‘  ğŸ›¡ï¸  NO PORN â€¢ NO HATE â€¢ NO FASCISM                         â•‘');
    printLine('â•‘                                                            â•‘');
    printLine('â•‘  Type "enter matrix" to access the social network          â•‘');
    printLine('â•‘  Type "help" for all available commands                    â•‘');
    printLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    printLine('');
    printLine('Connected as: ' + username);
    printLine('');
  }

  function logout() {
    terminal.style.display = 'none';
    loginScreen.style.display = 'block';
    output.innerHTML = '';
    usernameInput.value = '';
    usernameInput.focus();
  }

  usernameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });

  function printLine(text, className) {
    const line = document.createElement('div');
    line.className = className || 'output-line';
    line.textContent = text;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
  }

  commandInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = commandInput.value.trim();
      if (cmd) {
        printLine(username + '@errordon:~$ ' + cmd, 'command-line');
        handleCommand(cmd);
      }
      commandInput.value = '';
    }
  });

  function handleCommand(input) {
    const lower = input.toLowerCase();
    const cmd = lower.split(' ')[0];
    const args = input.split(' ').slice(1);

    if (lower === 'enter matrix' || lower === 'entermatrix' || lower === 'login') {
      printLine('[INITIATING NEURAL INTERFACE...]');
      setTimeout(() => {
        printLine('[CONNECTING TO ERRORDON NETWORK...]');
        setTimeout(() => {
          printLine('[ACCESS GRANTED - REDIRECTING...]');
          setTimeout(() => { window.location.href = '/auth/sign_in'; }, 800);
        }, 800);
      }, 800);
      return;
    }

    if (lower === 'register' || lower === 'signup') {
      printLine('');
      printLine('[ACCESS DENIED]', 'error-line');
      printLine('');
      printLine('Registration requires an invitation link.');
      printLine('Ask an existing member for an invite.');
      printLine('');
      printLine('Already have an invite? Use: invite <code>');
      return;
    }

    // Invite command
    if (cmd === 'invite' && args.length > 0) {
      const code = args.join('');
      printLine('[VALIDATING INVITATION CODE...]');
      setTimeout(() => {
        printLine('[ACCESSING REGISTRATION MATRIX...]');
        setTimeout(() => { window.location.href = '/invite/' + encodeURIComponent(code); }, 800);
      }, 800);
      return;
    }
    if (cmd === 'invite' && args.length === 0) {
      printLine('Usage: invite <code>', 'error-line');
      printLine('Example: invite abc123xyz');
      return;
    }

    if (cmd === 'about') {
      printLine('');
      printLine('ERRORDON - A Safe Fediverse Instance');
      printLine('=====================================');
      printLine('ğŸ›¡ï¸  AI-Powered Content Moderation (NSFW-Protect)');
      printLine('ğŸš«  Zero Tolerance: No Porn, No Hate, No Fascism');
      printLine('ğŸŒ  Fediverse Compatible (ActivityPub)');
      printLine('ğŸ“Š  Dynamic Storage Quotas');
      printLine('ğŸ¨  Matrix Theme');
      printLine('');
      printLine('Type "enter matrix" to join the network.');
      return;
    }

    if (cmd === 'clear') { output.innerHTML = ''; return; }

    if (cmd === 'help') {
      printLine('');
      printLine('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
      printLine('â•‘              ERRORDON TERMINAL COMMANDS               â•‘');
      printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
      printLine('â•‘  enter matrix  - ğŸ”“ Access Errordon Social Network    â•‘');
      printLine('â•‘  invite <code> - ğŸ“ Register with invite code         â•‘');
      printLine('â•‘  about         - â„¹ï¸  About Errordon                    â•‘');
      printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
      printLine('â•‘  tetris        - ğŸ® Play Tetris game                  â•‘');
      printLine('â•‘  quote         - ğŸ“œ Random Matrix quote               â•‘');
      printLine('â•‘  hack          - ğŸ’» Hack simulation                   â•‘');
      printLine('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
      printLine('â•‘  rain          - ğŸŒ§ï¸  Toggle Matrix rain               â•‘');
      printLine('â•‘  clear         - ğŸ§¹ Clear screen                      â•‘');
      printLine('â•‘  date          - ğŸ“… Show date/time                    â•‘');
      printLine('â•‘  whoami        - ğŸ‘¤ Show current user                 â•‘');
      printLine('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      printLine('');
      return;
    }

    if (cmd === 'rain') {
      rainActive = !rainActive;
      if (!rainActive) { matrixCtx.fillStyle = '#000'; matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height); }
      printLine('Matrix rain ' + (rainActive ? 'enabled' : 'disabled'));
      return;
    }

    if (cmd === 'date') { printLine(new Date().toString()); return; }
    if (cmd === 'whoami') { printLine(username); return; }
    if (cmd === 'echo') { printLine(args.join(' ')); return; }

    if (cmd === 'quote') {
      const quotes = [
        "There is no spoon.", "You take the red pill â€” you stay in Wonderland.",
        "I know kung fu.", "Welcome to the real world.",
        "Unfortunately, no one can be told what the Matrix is. You have to see it for yourself.",
        "Free your mind.", "He's beginning to believe!", "Follow the white rabbit!"
      ];
      printLine(quotes[Math.floor(Math.random() * quotes.length)]);
      return;
    }

    if (cmd === 'hack') {
      const msgs = ["[ACCESSING MAINFRAME...]", "[ENCRYPTION BYPASS...]", "[CRYPTO-BARRIER BREACHED]", "[LOGGING IN AS ROOT...]", "[MISSION COMPLETE]"];
      let i = 0;
      const interval = setInterval(() => {
        if (i < msgs.length) printLine(msgs[i++]);
        else clearInterval(interval);
      }, 500);
      return;
    }

    if (cmd === 'tetris') {
      printLine('Loading Tetris...');
      document.getElementById('tetrisOverlay').style.display = 'block';
      document.getElementById('tetrisFrame').src = '/matrix/tetris.html?user=' + encodeURIComponent(username);
      return;
    }

    printLine('Unknown command: ' + cmd, 'error-line');
    printLine('Type "help" for available commands');
  }

  window.addEventListener('message', (e) => {
    if (e.data === 'closeTetris') {
      document.getElementById('tetrisOverlay').style.display = 'none';
      document.getElementById('tetrisFrame').src = '';
    }
  });
